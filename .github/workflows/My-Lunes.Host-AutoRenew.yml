name: My-Lunes.Host-AutoRenew

on:
  schedule:
    # æ¯ 3 å¤©è¿è¡Œä¸€æ¬¡ (UTC æ—¶é—´ 0:00)
    - cron: '0 0 */3 * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

permissions:
  contents: write
  actions: write  

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4 # å‡çº§åˆ° v4
        with:
          repository: ${{ github.repository_owner }}/My-Lunes.Host-AutoRenew
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}        
          fetch-depth: 0

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5 # å‡çº§åˆ° v5
        with:
          python-version: '3.10'

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y libpci3 libegl1 libgles2 libnss3

      - name: å®‰è£… Python ä¾èµ–
        run: |
          pip install -r requirements.txt -q > /dev/null 2>&1
                    
      - name: ğŸ“¦ å®‰è£… Hysteria2 å®¢æˆ·ç«¯
        run: |
          wget -O hysteria https://github.com/apernet/hysteria/releases/latest/download/hysteria-linux-amd64
          chmod +x hysteria
          sudo mv hysteria /usr/local/bin/hysteria
          hysteria version
        
      - name: ğŸ“¦ å®‰è£… Xray å†…æ ¸
        run: |
          mkdir -p ./xray_temp
          wget -O xray.zip https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q xray.zip -d ./xray_temp
          sudo mv ./xray_temp/xray /usr/local/bin/xray
          sudo chmod +x /usr/local/bin/xray
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf ./xray_temp xray.zip
          echo "âœ… Xray å®‰è£…å®Œæˆï¼Œä¸”æœªæ±¡æŸ“æ ¹ç›®å½•"
          
      - name: è¿è¡ŒMainè„šæœ¬
        env:
          PROXY_URL: ${{ secrets.PROXY_URL }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          touch storage_state.json  # ç¡®ä¿æ–‡ä»¶å­˜åœ¨ï¼Œé¿å… git add æ—¶å®Œå…¨æ‰¾ä¸åˆ°æ–‡ä»¶
          python main.py

      - name: æäº¤å˜æ›´ (README & JSON)
        if: always()
        run: |
          # ä¿®æ”¹ README å†…å®¹ (è¦†ç›–å†™å…¥ï¼ŒåŒ…å«æ—¶é—´æˆ³)
          CN_TIME=$(date -d "+8 hours" "+%Y-%m-%d %H:%M:%S")
          echo "# Lunes.Host Auto Renew" > README.md
          echo "" >> README.md
          echo "âœ… ä»»åŠ¡æœ€åæ‰§è¡Œæ—¶é—´ (åŒ—äº¬): \`$CN_TIME\`" >> README.md
          echo "" >> README.md
          echo "> çŠ¶æ€ç”± GitHub Actions è‡ªåŠ¨ç»´æŠ¤" >> README.md
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add storage_state.json README.md || true
          
          git diff --staged --quiet || git commit -m "Update Lunes.Host State & README [skip ci]"
          git push origin ${{ github.ref_name }} || echo "Push failed"

      - name: ä¸Šä¼ æˆªå›¾ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: ./*.png

      - name: æ¸…ç†è¿è¡Œå†å²
        if: always()
        uses: MajorScruffy/delete-old-workflow-runs@v0.3.0
        with:
          repository: ${{ github.repository }}
          older-than-seconds: 86400
        env:
          GITHUB_TOKEN: ${{ github.token }}  
